# Reset Rabbit

## Introduction

A proof of concept (PoC) tool for testing Denial of Service (DoS) attacks on HTTP/2 web server, inspired by the technique described in [CVE-2023-44487](https://www.cve.org/CVERecord?id=CVE-2023-44487).

This repository has been extended to include both a vulnerable environment and a mitigation setup to demonstrate the effects of the attack and the effectiveness of mitigations.

## Repository Overview

### Original Features 
- A Go-based script (`reset-rabbit.go`) that performs the HTTP/2 rapid reset attack to simulate a DoS scenario.

### Added Features
1. **Exploit Setup**:
    - The `exploit` folder contains: 
        - `reset-rabbit.go`: The Go script for performing the attack.
        - `simulation.yaml`: A `docker-compose` file to spin up the vulnerable Apache HTTP/2 server without mitigations.    

2. **Mitigation Setup**:
    - Created a `mitigation` folder with: 
        - `certs/`: Contains SSL certificates for Nginx (generated by `gen_ssl_cert.sh`).
        - `logs/`: Contains `access.log`, linked to the Nginx log directory in the container to track incoming requests.
        - `gen_ssl_cert.sh`: A script to automate SSL certificate generation for Nginx.
        - `nginx.conf`: Contains Nginx configuration for mitigating the attack, using: 
            - `keepalive_requests 1000` to limit the number of keepalive requests per connection.
            - `http2_max_concurrent_streams 128` to retrict concurrent HTTP/2 streams.
        - `mitigation.yaml`: A `docker-compose` file to run both the vulnerable server and the Nginx reverse proxy with mitigation.
            - 1 Nginx container.
            - 1 Vulnerable Apache server container.
            - 3 Wazuh containers (server, API, and Elasticsearch) for enhanced logging and attack detection.
        - `wazuh/manager/`: Contains:
            - `local_rules.xml`: Custom Wazuh rules for detecting HTTP/2 DoS attacks.

---

## Usage

### **Building the Vulnerable Apache Docker Image**
Before running the exploit or mitigation setup, you need to create the Docker image for the vulnerable Apache server. Navigate to the `exploit` folder and run the following command:
```bash 
sudo docker build -t vulnerable-apache ./vulnerable-apache
```
This will build the `vulnerable-apache` image required for both the exploit and mitigation demonstrations.

### **Exploit Setup**
To run the vulnerable server and perform the attack: 

1. **Build and Start the Vulnerable Server**:
    ```bash
    cd exploit
    sudo docker-compose -f simulation.yaml up -d
    ```

2. **Run the Exploit**:
    ```bash 
    go run reset-rabbit.go -url https://localhost:8443 -limit 1000
    ```

    - You may need to adjust the `-limit` parameter to simulate the attack on servers with more resources.
    - After a few seconds, the server will stop responding a legitimate requests.

---
### **Mitigation Setup**
To run the server with Nginx mitigation enabled:

1. **Clone the Wazuh Docker Repository**: Clone the official Wazuh Docker repository to get the necessary configuration and setup files for deploying Wazuh in a single-node configuration: 
    ```bash 
    git clone https://github.com/wazuh/wazuh-docker.git -b v4.10.1
    ```
    Navigate to the `single-node` directory within the cloned repository: 
    ```bash 
    cd wazuh-docker/single-node
    ```

2. **Generate SSL Certificates for Wazuh**: 
    Follow the instructions in the [Wazuh Documentation](https://documentation.wazuh.com/current/deployment-options/docker/wazuh-container.html) to generate the necessary SSL certificates for the single-node deployment.

3. **Generate SSL Certificates for Nginx**:
    In the `mitigation` folder, run the script to generate SSL certificates for Nginx:
    ```bash
    cd mitigation
    bash gen_ssl_cert.sh
    ```

4. **Prepare Logs**: 
    Ensure placeholder `access.log` and `error.log` files exist in the `logs/` folder: 
    ```bash 
    touch logs/access.log logs/error.log
    ```

5. **Edit Wazuh Configuration**: 
    Navigate to the `wazuh-docker/single-node/config/wazuh_cluster/` directory and update `wazuh_manager.conf`:
    ```xml
    <localfile>
        <log_format>syslog</log_format>
        <location>/var/log/nginx/access.log</location>
    </localfile>
    <localfile>
        <log_format>syslog</log_format>
        <location>/var/log/nginx/error.log</location>
    </localfile>
    ```

6. **Update Volume Paths**: 
Open `mitigation.yaml` and ensure that the volume paths in the Wazuh containers point to the correct locations on your system. For example:
    ```yaml
    volumes:
        - /home/cve/wazuh-docker/single-node/config/wazuh_indexer_ssl_certs/wazuh.dashboard.pem:/usr/share/wazuh-dashboard/certs/wazuh-dashboard.pem
    ```
    Update `/home/cve/wazuh-docker/...` to match the actual path to the Wazuh Docker configuration files on your device.

7. **Start the Mitigated Environment**: 
    ```bash 
    sudo docker-compose -f mitigation.yaml up -d 
    ```

    This starts: 
    - Nginx as a reverse proxy with mitigations. 
    - The vulnerable Apache server.
    - Wazuh components (server, API, Elasticsearch).

8. **Run the Exploit Against the Mitigated Server**:
    ```bash 
    cd .. 
    cd exploit 
    go run reset-rabbit.go -url https://localhost -limit 1000
    ```

    - The attack should be mitigated. Nginx will log excessive requests, and Wazuh will analyse the logs in real time.

---

### Wazuh Dashboard 
Access the Wazuh dashboard at https://localhost:8443. Use the `Discover` tab to view real-time logs and filter by rule IDs: 
```bash 
rule-id: 100001 OR rule-id: 100002
```

---
## Directory Structure

```bash
.
├── exploit
│   ├── go.mod
│   ├── go.sum
│   ├── reset-rabbit.go
│   └── simulation.yaml
├── mitigation
│   ├── certs
│   │   ├── server.crt
│   │   └── server.key
│   ├── gen_ssl_cert.sh
│   ├── logs
│   │   ├── access.log
│   │   └── error.log
│   ├── mitigation.yaml
│   ├── nginx.conf
│   └── wazuh_manager
│       └── local_rules.xml
├── readme.md
└── vulnerable-apache
    └── Dockerfile
```

---

## Wazuh Custom Rules 
Custom rules are added to Wazuh to detect and alert on potential HTTP/2 DoS attacks based on Nginx logs. These rules are defined in `local_rules.xml`
```xml
<group name="nginx">
        <!-- Rule for HTTP 503 error -->
        <rule id="100001" level="15" frequency="100" timeframe="30" overwrite="yes">
                <if_matched_sid>31123</if_matched_sid>
                <match>HTTP/2.0" 503</match>
                <description>Potential DoS attack detected: High number of 503 responses</description>
                <group>nginx, attack</group>
        </rule>

        <rule id="100002" level="15" frequency="100" timeframe="30" overwrite="yes">
                <if_matched_sid>31301</if_matched_sid>
                <match>limiting requests</match>
                <description>Potential DoS attack:Excessive request from a single IP</description>
                <group>nginx, attack</group>
        </rule>
        <rule id="31163" level="0" overwrite="yes" noalert="1">
                <description> Rule suppression</description>
        </rule>
</group>
```
### Explanation of the Rules: 
1. **Rule ID 100001**:
    - Detects a high number of HTTP 503 error responses (service unavailable) in the Nginx logs. 
    - Triggers when 100 instances are logged within a 30-second window.
2. **Rule ID 100002**: 
    - Detects excessive requests from a single IP address, as indicated by Nginx's rate-limiting logs. 
    - Helps identify potential abusive clients or bots 
3. **Rule ID 31163**: 
    - Suppresses less critical alerts to reduce noise in the logs.

By monitoring these rules in the Wazuh dashboard, administrators can identify and investigate potential attacks in realtime. Logs can be filtered using: 
```
rule-id: 100001 OR rule-id: 100002
```



## How Nginx Mitigates the Attack 
In this setup, Nginx acts as a **reverse proxy**, standing between the attacker and the vulnerable server. It applies the following mitigations to limit the impact of HTTP/2 rapid reset attacks:
- **Limit Keepalive Requests**:
    ```nginx
    keepalive_requests 1000;
    ```
    This ensures  that each connection is automatically closed after serving 1000 requests, preventing excessive reuse of a single connection for abusive traffic    

- **Restrict HTTP/2 Concurrent Streams**:
    ```nginx
    http2_max_concurrent_streams 128;
    ```
    This limits the number of concurrent streams allowed in a HTTP/2 connection to 128, reducing the likelihood of resource exhaustion.

These configurations help ensure the server remains available to legitimate users, even under attack.
---

## Notes

- This PoC is intended for demonstration purposes only.
- The tool and configurations are designed for testing and understanding the attack and mitigation in controlled environments.
- Using this tool on live systems without permission is strictly prohibited.

---

## Acknowledgements

Original repository by [PatrickTulskie reset-rabbit](https://github.com/PatrickTulskie/reset-rabbit).
